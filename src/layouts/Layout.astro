---
import "../styles/global.css";
import {
  getLangFromUrl,
  useTranslations,
  useTranslatedPath,
} from "../i18n/utils";

interface Props {
  title: string;
  description?: string;
  currentPage?: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const {
  title,
  description = lang === "es"
    ? "Grip Club - Carrera de Resistencia 8 Horas en motos 125cc de serie. La experiencia definitiva del motorsport amateur."
    : "Grip Club - 8 Hours Endurance Race on stock 125cc motorcycles. The ultimate amateur motorsport experience.",
  currentPage = "historia",
} = Astro.props;

const altLang = lang === "es" ? "en" : "es";
const altPath =
  lang === "es"
    ? `/en${Astro.url.pathname}`
    : Astro.url.pathname.replace("/en", "") || "/";
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="description" content={description} />
    <meta
      name="keywords"
      content="motos, 125cc, resistencia, endurance, carrera, motorsport, Grip Club, Espa침a"
    />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link
      rel="alternate"
      hreflang="es"
      href={`https://gripclub.es${Astro.url.pathname.replace("/en", "") || "/"}`}
    />
    <link
      rel="alternate"
      hreflang="en"
      href={`https://gripclub.es/en${Astro.url.pathname.replace("/en", "")}`}
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>{title} | Grip Club</title>
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- Header / Navigation -->
    <header
      class="fixed top-0 left-0 right-0 z-50 bg-racing-black/90 backdrop-blur-md border-b border-racing-silver/10"
    >
      <nav class="container mx-auto px-4 md:px-8">
        <div class="flex items-center justify-between h-20">
          <!-- Logo -->
          <a href={translatePath("/")} class="flex items-center group">
            <img
              src="/logo/logo_text_only_white.png"
              alt="Grip Club"
              class="h-10 w-auto group-hover:opacity-80 transition-opacity"
            />
          </a>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center gap-6">
            <a
              href={translatePath("/")}
              class={`nav-link nav-link-secondary ${currentPage === "home" ? "active" : ""}`}
              >Home</a
            >
            <a
              href={translatePath("/eventos")}
              class={`nav-link nav-link-secondary ${currentPage === "eventos" ? "active" : ""}`}
              >{t("nav.eventos")}</a
            >
            <a
              href={translatePath("/motos")}
              class={`nav-link nav-link-secondary ${currentPage === "motos" ? "active" : ""}`}
              >{t("nav.motos")}</a
            >
            <a
              href={translatePath("/reglamento")}
              class={`nav-link nav-link-tertiary ${currentPage === "reglamento" ? "active" : ""}`}
              >{t("nav.reglamento")}</a
            >
            <a
              href={translatePath("/inscripciones")}
              class={`nav-link nav-link-primary ${currentPage === "inscripciones" ? "active" : ""}`}
              >{t("nav.inscripciones")}</a
            >
            <a
              href={translatePath("/tienda")}
              class={`nav-link nav-link-tertiary ${currentPage === "tienda" ? "active" : ""}`}
              >{t("nav.tienda")}</a
            >

            <!-- Language Switcher -->
            <a
              href={altPath}
              class="lang-switch"
              aria-label={altLang === "en"
                ? "Switch to English"
                : "Cambiar a Espa침ol"}
            >
              <span class="flag">{lang === "en" ? "游섫릖" : "游쀯릖"}</span>
              <span class="label">{lang.toUpperCase()}</span>
            </a>
          </div>

          <!-- Auth / Dashboard Button Desktop -->
          <div class="hidden md:flex items-center gap-3">
            <a
              id="desktop-login-btn"
              href={translatePath("/auth/login")}
              class="btn-primary-highlight"
            >
              {t("nav.login")}
            </a>
            <a
              id="desktop-dashboard-btn"
              href={translatePath("/dashboard")}
              class="hidden btn-primary-highlight"
            >
              {t("nav.dashboard")}
            </a>
          </div>

          <!-- Mobile Menu Button -->
          <button
            id="mobile-menu-btn"
            class="md:hidden text-white p-2"
            aria-label="Abrir men칰"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>

        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="md:hidden hidden pb-6">
          <div
            class="flex flex-col gap-4 pt-4 border-t border-racing-silver/10"
          >
            <a
              href={translatePath("/")}
              class={`nav-link nav-link-secondary ${currentPage === "home" ? "active" : ""}`}
              >Home</a
            >
            <a
              href={translatePath("/eventos")}
              class={`nav-link nav-link-secondary ${currentPage === "eventos" ? "active" : ""}`}
              >{t("nav.eventos")}</a
            >
            <a
              href={translatePath("/motos")}
              class={`nav-link nav-link-secondary ${currentPage === "motos" ? "active" : ""}`}
              >{t("nav.motos")}</a
            >
            <a
              href={translatePath("/reglamento")}
              class={`nav-link nav-link-tertiary ${currentPage === "reglamento" ? "active" : ""}`}
              >{t("nav.reglamento")}</a
            >
            <a
              href={translatePath("/inscripciones")}
              class={`nav-link nav-link-primary ${currentPage === "inscripciones" ? "active" : ""}`}
              >{t("nav.inscripciones")}</a
            >
            <a
              href={translatePath("/tienda")}
              class={`nav-link nav-link-tertiary ${currentPage === "tienda" ? "active" : ""}`}
              >{t("nav.tienda")}</a
            >
            <a
              href={altPath}
              class="lang-switch inline-flex"
              aria-label={altLang === "en"
                ? "Switch to English"
                : "Cambiar a Espa침ol"}
            >
              <span class="flag">{lang === "en" ? "游섫릖" : "游쀯릖"}</span>
              <span class="label">{lang.toUpperCase()}</span>
            </a>
            <a
              id="mobile-login-btn"
              href={translatePath("/auth/login")}
              class="btn-primary-highlight text-center mt-4">{t("nav.login")}</a
            >
            <a
              id="mobile-dashboard-btn"
              href={translatePath("/dashboard")}
              class="hidden btn-primary-highlight text-center mt-4"
              >{t("nav.dashboard")}</a
            >
          </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow pt-20">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="bg-racing-gray border-t border-racing-silver/10">
      <div class="container mx-auto px-4 md:px-8 py-12">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
          <!-- Brand -->
          <div>
            <div class="mb-4">
              <img
                src="/logo/logo_text_only_white.png"
                alt="Grip Club"
                class="h-8 w-auto"
              />
            </div>
            <p class="text-racing-silver text-sm">
              {t("footer.description")}
            </p>
          </div>

          <!-- Quick Links -->
          <div>
            <h4 class="text-white font-bold mb-4 uppercase tracking-wider">
              {t("footer.links")}
            </h4>
            <ul class="space-y-2">
              <li>
                <a
                  href={translatePath("/historia")}
                  class="text-racing-silver hover:text-vanilla transition-colors"
                  >{t("nav.historia")}</a
                >
              </li>
              <li>
                <a
                  href={translatePath("/eventos")}
                  class="text-racing-silver hover:text-vanilla transition-colors"
                  >{t("nav.eventos")}</a
                >
              </li>
              <li>
                <a
                  href={translatePath("/motos")}
                  class="text-racing-silver hover:text-vanilla transition-colors"
                  >{t("nav.motos")}</a
                >
              </li>
              <li>
                <a
                  href={translatePath("/inscripciones")}
                  class="text-racing-silver hover:text-vanilla transition-colors"
                  >{t("nav.inscripciones")}</a
                >
              </li>
              <li>
                <a
                  href={translatePath("/reglamento")}
                  class="text-racing-silver hover:text-vanilla transition-colors"
                  >{t("nav.reglamento")}</a
                >
              </li>
            </ul>
          </div>

          <!-- Contact -->
          <div>
            <h4 class="text-white font-bold mb-4 uppercase tracking-wider">
              {t("footer.contact")}
            </h4>
            <ul class="space-y-2 text-racing-silver">
              <li class="flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-vanilla"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  ></path>
                </svg>
                info@gripclub.es
              </li>
              <li class="flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-vanilla"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Espa침a
              </li>
            </ul>
          </div>
        </div>

        <!-- Bottom -->
        <div
          class="pt-8 border-t border-racing-silver/10 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <p class="text-racing-silver text-sm">
            &copy; {new Date().getFullYear()} Grip Club. {t("footer.rights")}
          </p>
          <p class="text-racing-silver/50 text-xs">
            {t("footer.inspired")}
          </p>
        </div>
      </div>
    </footer>

    <!-- Mobile Menu Script -->
    <script>
      const mobileMenuBtn = document.getElementById("mobile-menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");

      mobileMenuBtn?.addEventListener("click", () => {
        mobileMenu?.classList.toggle("hidden");
      });
    </script>

    <!-- Firebase Auth Script -->
    <script>
      import { firebaseAuth } from "../lib/firebase-auth";

      await firebaseAuth.init();

      // Toggle auth buttons based on login state
      function updateAuthUI(user: any) {
        const desktopLoginBtn = document.getElementById("desktop-login-btn");
        const desktopDashboardBtn = document.getElementById(
          "desktop-dashboard-btn",
        );
        const mobileLoginBtn = document.getElementById("mobile-login-btn");
        const mobileDashboardBtn = document.getElementById(
          "mobile-dashboard-btn",
        );

        if (user) {
          desktopLoginBtn?.classList.add("hidden");
          desktopDashboardBtn?.classList.remove("hidden");
          mobileLoginBtn?.classList.add("hidden");
          mobileDashboardBtn?.classList.remove("hidden");
        } else {
          desktopLoginBtn?.classList.remove("hidden");
          desktopDashboardBtn?.classList.add("hidden");
          mobileLoginBtn?.classList.remove("hidden");
          mobileDashboardBtn?.classList.add("hidden");
        }
      }

      // Initial check - wait for user state to be ready
      const user = await firebaseAuth.waitForUser();
      updateAuthUI(user);

      // Listen for auth changes
      firebaseAuth.onAuthChange(updateAuthUI);
    </script>
  </body>
</html>
