---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import {
  getLangFromUrl,
  useTranslations,
  useTranslatedPath,
} from "../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
---

<DashboardLayout title={t("dashboard.teamInfo")} currentSection="equipo">
  <div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-8">
      <h1
        class="text-3xl font-bold text-white"
        style="font-family: 'Bebas Neue', sans-serif;"
      >
        {t("dashboard.teamInfo")}
      </h1>
      <a
        href={translatePath("/dashboard")}
        class="text-racing-silver hover:text-white transition-colors"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </a>
    </div>

    <!-- Loading State -->
    <div
      id="loading-state"
      class="bg-racing-gray rounded-xl p-8 border border-racing-silver/10 flex items-center justify-center"
    >
      <svg
        class="animate-spin w-8 h-8 text-racing-green"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
    </div>

    <!-- Team Form -->
    <form id="team-form" class="hidden space-y-6">
      <!-- Team Data -->
      <div
        class="bg-racing-gray rounded-xl p-6 border border-racing-silver/10 space-y-4"
      >
        <h2 class="text-lg font-bold text-white mb-4">Datos del Equipo</h2>

        <div>
          <label
            for="name"
            class="block text-sm font-medium text-racing-silver mb-2"
            >{t("form.teamName")} *</label
          >
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            placeholder="Ej: Racing Team Alpha"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              for="numberOfPilots"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.numberOfPilots")} *</label
            >
            <select
              id="numberOfPilots"
              name="numberOfPilots"
              required
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            >
              <option value="4">4 pilotos</option>
              <option value="5">5 pilotos</option>
              <option value="6">6 pilotos</option>
              <option value="7">7 pilotos</option>
              <option value="8">8 pilotos</option>
            </select>
          </div>

          <div>
            <label
              for="preferredNumber"
              class="block text-sm font-medium text-racing-silver mb-2 flex items-center gap-2"
            >
              {t("form.preferredNumber")}
              <span class="relative group">
                <svg class="w-4 h-4 text-racing-silver/60 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-racing-black border border-racing-silver/20 rounded-lg text-xs text-racing-silver w-48 text-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                  {t("form.preferredNumberHint")}
                </span>
              </span>
            </label>
            <input
              type="number"
              id="preferredNumber"
              name="preferredNumber"
              min="1"
              max="99"
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
              placeholder="Ej: 46"
            />
          </div>
        </div>
      </div>

      <!-- Representative Info -->
      <div
        class="bg-racing-gray rounded-xl p-6 border border-racing-silver/10 space-y-4"
      >
        <h2 class="text-lg font-bold text-white mb-4">
          Representante del Equipo
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              for="representativeName"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.representativeName")} *</label
            >
            <input
              type="text"
              id="representativeName"
              name="representativeName"
              required
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            />
          </div>

          <div>
            <label
              for="representativeSurname"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.representativeSurname")} *</label
            >
            <input
              type="text"
              id="representativeSurname"
              name="representativeSurname"
              required
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              for="representativeDni"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.representativeDni")} *</label
            >
            <input
              type="text"
              id="representativeDni"
              name="representativeDni"
              required
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
              placeholder="12345678A"
            />
          </div>

          <div>
            <label
              for="representativePhone"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.representativePhone")} *</label
            >
            <input
              type="tel"
              id="representativePhone"
              name="representativePhone"
              required
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
              placeholder="+34 600 000 000"
            />
          </div>
        </div>

        <div>
          <label
            for="representativeEmail"
            class="block text-sm font-medium text-racing-silver mb-2"
            >{t("form.representativeEmail")} *</label
          >
          <input
            type="email"
            id="representativeEmail"
            name="representativeEmail"
            required
            class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            placeholder="email@ejemplo.com"
          />
        </div>
      </div>

      <!-- Address Info -->
      <div
        class="bg-racing-gray rounded-xl p-6 border border-racing-silver/10 space-y-4"
      >
        <h2 class="text-lg font-bold text-white mb-4">{t("form.address")}</h2>

        <div>
          <label
            for="address"
            class="block text-sm font-medium text-racing-silver mb-2"
            >{t("form.address")}</label
          >
          <input
            type="text"
            id="address"
            name="address"
            class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label
              for="municipality"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.municipality")}</label
            >
            <input
              type="text"
              id="municipality"
              name="municipality"
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            />
          </div>

          <div>
            <label
              for="postalCode"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.postalCode")}</label
            >
            <input
              type="text"
              id="postalCode"
              name="postalCode"
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            />
          </div>

          <div>
            <label
              for="province"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.province")}</label
            >
            <input
              type="text"
              id="province"
              name="province"
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
            />
          </div>
        </div>
      </div>

      <!-- Motorcycle Info -->
      <div
        class="bg-racing-gray rounded-xl p-6 border border-racing-silver/10 space-y-4"
      >
        <h2 class="text-lg font-bold text-white mb-4">{t("dashboard.motorcycle")}</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              for="motorcycleBrand"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.motorcycleBrand")}</label
            >
            <input
              type="text"
              id="motorcycleBrand"
              name="motorcycleBrand"
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
              placeholder="Ej: Honda, Yamaha, Aprilia..."
            />
          </div>

          <div>
            <label
              for="motorcycleModel"
              class="block text-sm font-medium text-racing-silver mb-2"
              >{t("form.motorcycleModel")}</label
            >
            <input
              type="text"
              id="motorcycleModel"
              name="motorcycleModel"
              class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white placeholder-racing-silver/50 focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
              placeholder="Ej: CBR125R, YZF-R125..."
            />
          </div>
        </div>

        <div>
          <label
            for="engineCapacity"
            class="block text-sm font-medium text-racing-silver mb-2"
            >{t("form.engineCapacity")} *</label
          >
          <select
            id="engineCapacity"
            name="engineCapacity"
            required
            class="w-full px-4 py-3 bg-racing-black border border-racing-silver/20 rounded-lg text-white focus:border-racing-green focus:ring-1 focus:ring-racing-green outline-none transition-colors"
          >
            <option value="125cc_4t">{t("form.engineCapacity.125cc")}</option>
            <option value="50cc_2t">{t("form.engineCapacity.50cc")}</option>
          </select>
        </div>

        <!-- Motorcycle Photo Upload -->
        <div>
          <label class="block text-sm font-medium text-racing-silver mb-2">
            {t("form.motorcyclePhoto")}
            <span class="text-racing-silver/60 font-normal ml-2">(opcional)</span>
          </label>
          <p class="text-xs text-racing-silver/60 mb-3">{t("form.motorcyclePhotoHint")}</p>

          <div id="photo-upload-container" class="relative">
            <!-- Photo preview (hidden by default) -->
            <div id="photo-preview" class="hidden relative rounded-lg overflow-hidden border border-racing-silver/20">
              <img id="photo-preview-img" src="" alt="Motorcycle preview" class="w-full h-48 object-cover" />
              <!-- Status badge -->
              <div id="photo-status-badge" class="absolute top-2 right-2 px-2 py-1 rounded text-xs font-semibold hidden">
              </div>
              <!-- Change photo button -->
              <button
                type="button"
                id="change-photo-btn"
                class="absolute bottom-2 right-2 px-3 py-1.5 bg-racing-black/80 hover:bg-racing-black border border-racing-silver/20 rounded-lg text-sm text-white transition-colors"
              >
                {t("form.changePhoto")}
              </button>
            </div>

            <!-- Upload button (shown when no photo) -->
            <label
              id="upload-photo-label"
              class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-racing-silver/20 rounded-lg cursor-pointer hover:border-racing-green/50 transition-colors"
            >
              <svg class="w-8 h-8 text-racing-silver/50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span class="text-sm text-racing-silver">{t("form.uploadPhoto")}</span>
              <input
                type="file"
                id="motorcyclePhoto"
                name="motorcyclePhoto"
                accept="image/*"
                class="hidden"
              />
            </label>
          </div>
        </div>
      </div>

      <!-- GDPR Consent -->
      <div class="bg-racing-gray rounded-xl p-6 border border-racing-silver/10">
        <label class="flex items-start gap-3 cursor-pointer">
          <input
            type="checkbox"
            id="gdprConsent"
            name="gdprConsent"
            required
            class="mt-1 w-5 h-5 rounded border-racing-silver/20 bg-racing-black text-racing-green focus:ring-racing-green focus:ring-offset-0"
          />
          <span class="text-sm text-racing-silver"
            >{t("form.gdprConsent")} *</span
          >
        </label>
      </div>

      <!-- Messages -->
      <div
        id="success-message"
        class="hidden p-4 bg-racing-green/20 border border-racing-green/50 rounded-lg text-racing-green text-sm"
      >
        Datos guardados correctamente
      </div>

      <div
        id="error-message"
        class="hidden p-4 bg-red-900/30 border border-red-500/50 rounded-lg text-red-300 text-sm"
      >
      </div>

      <!-- Submit Button -->
      <div class="flex gap-4">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 btn-primary py-4 flex items-center justify-center gap-2"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"></path>
          </svg>
          {t("dashboard.save")}
        </button>
        <a
          href={translatePath("/dashboard")}
          class="px-6 py-4 border border-racing-silver/20 rounded-lg text-racing-silver hover:text-white hover:border-racing-silver/40 transition-colors"
        >
          {t("dashboard.cancel")}
        </a>
      </div>
    </form>
  </div>

  <script>
    import { firebaseAuth, fetchWithAuth } from "../../lib/firebase-auth";

    const lang = document.documentElement.lang || "es";
    const dashboardPath = lang === "en" ? "/en/dashboard" : "/dashboard";

    // Elements
    const loadingState = document.getElementById("loading-state");
    const teamForm = document.getElementById("team-form") as HTMLFormElement;
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");
    const submitBtn = document.getElementById("submit-btn");

    let existingTeam: any = null;

    // Form field names (camelCase to match API)
    const fields = [
      "name",
      "preferredNumber",
      "numberOfPilots",
      "representativeName",
      "representativeSurname",
      "representativeDni",
      "representativePhone",
      "representativeEmail",
      "address",
      "municipality",
      "postalCode",
      "province",
      "motorcycleBrand",
      "motorcycleModel",
      "engineCapacity",
      "gdprConsent",
    ];

    // Photo upload elements
    const photoInput = document.getElementById("motorcyclePhoto") as HTMLInputElement;
    const photoPreview = document.getElementById("photo-preview");
    const photoPreviewImg = document.getElementById("photo-preview-img") as HTMLImageElement;
    const uploadPhotoLabel = document.getElementById("upload-photo-label");
    const changePhotoBtn = document.getElementById("change-photo-btn");
    const photoStatusBadge = document.getElementById("photo-status-badge");

    let pendingPhotoFile: File | null = null;

    // Photo status colors
    const statusColors: Record<string, { bg: string; text: string; label: string }> = {
      pending: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', label: 'Pendiente' },
      approved: { bg: 'bg-green-500/20', text: 'text-green-400', label: 'Aprobada' },
      rejected: { bg: 'bg-red-500/20', text: 'text-red-400', label: 'Rechazada' },
    };

    function showPhotoStatus(status: string | undefined) {
      if (!photoStatusBadge || !status) {
        photoStatusBadge?.classList.add('hidden');
        return;
      }
      const colors = statusColors[status] || statusColors.pending;
      photoStatusBadge.className = `absolute top-2 right-2 px-2 py-1 rounded text-xs font-semibold ${colors.bg} ${colors.text}`;
      photoStatusBadge.textContent = colors.label;
      photoStatusBadge.classList.remove('hidden');
    }

    function showPhotoPreview(url: string, status?: string) {
      if (photoPreviewImg) photoPreviewImg.src = url;
      photoPreview?.classList.remove('hidden');
      uploadPhotoLabel?.classList.add('hidden');
      showPhotoStatus(status);
    }

    function hidePhotoPreview() {
      photoPreview?.classList.add('hidden');
      uploadPhotoLabel?.classList.remove('hidden');
      photoStatusBadge?.classList.add('hidden');
    }

    // Handle photo selection
    photoInput?.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        pendingPhotoFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          showPhotoPreview(e.target?.result as string);
        };
        reader.readAsDataURL(file);
      }
    });

    // Handle change photo button
    changePhotoBtn?.addEventListener('click', () => {
      photoInput?.click();
    });

    async function loadTeamData() {
      try {
        const response = await fetchWithAuth("/api/teams");
        const data = await response.json();

        loadingState?.classList.add("hidden");
        teamForm?.classList.remove("hidden");

        if (data.team) {
          existingTeam = data.team;

          // Populate form fields
          fields.forEach((field) => {
            const input = document.getElementById(field) as
              | HTMLInputElement
              | HTMLSelectElement;
            if (
              input &&
              data.team[field] !== undefined &&
              data.team[field] !== null
            ) {
              if (input.type === "checkbox") {
                (input as HTMLInputElement).checked = data.team[field];
              } else {
                input.value = data.team[field].toString();
              }
            }
          });

          // Show motorcycle photo if exists
          if (data.team.motorcyclePhoto) {
            showPhotoPreview(data.team.motorcyclePhoto, data.team.motorcyclePhotoStatus);
          }
        } else {
          // Pre-fill email from logged user
          const user = firebaseAuth.getUser();
          if (user) {
            const emailInput = document.getElementById("representativeEmail") as HTMLInputElement;
            if (emailInput) emailInput.value = user.email;
          }
        }
      } catch (error) {
        console.error("Error loading team:", error);
        loadingState?.classList.add("hidden");
        teamForm?.classList.remove("hidden");
      }
    }

    teamForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      successMessage?.classList.add("hidden");
      errorMessage?.classList.add("hidden");

      if (submitBtn) {
        submitBtn.setAttribute("disabled", "true");
        submitBtn.textContent = "Guardando...";
      }

      const body: Record<string, any> = {};

      fields.forEach((field) => {
        const input = document.getElementById(field) as
          | HTMLInputElement
          | HTMLSelectElement;
        if (input) {
          if (input.type === "checkbox") {
            body[field] = (input as HTMLInputElement).checked;
          } else if (input.type === "number" || field === "numberOfPilots" || field === "preferredNumber") {
            const val = input.value;
            body[field] = val ? parseInt(val, 10) : null;
          } else {
            body[field] = input.value;
          }
        }
      });

      // Handle photo upload if there's a pending file
      if (pendingPhotoFile) {
        const reader = new FileReader();
        const photoData = await new Promise<string>((resolve) => {
          reader.onload = (e) => resolve(e.target?.result as string);
          reader.readAsDataURL(pendingPhotoFile!);
        });
        body.motorcyclePhoto = photoData;
      }

      try {
        const method = existingTeam ? "PUT" : "POST";
        const response = await fetchWithAuth("/api/teams", {
          method,
          body: JSON.stringify(body),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Error al guardar");
        }

        successMessage?.classList.remove("hidden");
        existingTeam = data.team;

        // Redirect to dashboard after 1.5s
        setTimeout(() => {
          window.location.href = dashboardPath;
        }, 1500);
      } catch (error: any) {
        console.error("Error saving team:", error);
        if (errorMessage) {
          errorMessage.textContent =
            error.message || "Error al guardar los datos";
          errorMessage.classList.remove("hidden");
        }
      } finally {
        if (submitBtn) {
          submitBtn.removeAttribute("disabled");
          submitBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Guardar
          `;
        }
      }
    });

    // Initialize and load data
    async function initAndLoad() {
      await firebaseAuth.waitForInit();

      const user = firebaseAuth.getUser();
      if (user) {
        loadTeamData();
      }

      firebaseAuth.onAuthChange((u) => {
        if (u) {
          loadTeamData();
        }
      });
    }

    initAndLoad();
  </script>
</DashboardLayout>
